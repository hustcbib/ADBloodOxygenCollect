# BloodOxygenCollect
AltiumDesignBloodOxygenCollect 

## 血氧检测仪产品

1. 长按触电开关，等待指示灯亮起，放开触电开关；
2. 打开**空中健康检测APP**，点击START 扫描护颈上的二维码，连接设备的蓝牙；
   + 点击开始检测，稍微等几秒钟，
   + 此时就能看到血氧检测的波形，和相关参数。

## 问题检查

1. 问题：长按触电开关，指示灯不亮？
   + 打开电池盒：首先更换新电池，如果更换电池后还是不亮；
   + 打开开发板的盒子：查看电源连接线和板子是否正常连接；
2. 问题：手机APP蓝牙连接不正常，或者重复连接不成功?
   + 打开电池盒：更换新电池；（干电池耗电特别快）
3. 问题：耳夹指示灯没亮？
   + 打开开发板的盒子：查看耳夹连接线和板子是否正常连接；
4. 问题：重新更换电池后，测量数据不正常；
   + 打开护颈：通过USB进行供电；
   + 打开空中健康检测APP：查看蓝牙是否能正常连接，查看能否看到数据的正常波形
   + 如果都不行：返厂维修。

## 电池的问题

1. 蓝牙连接不了，或者重复连接不成功

2. 电池电量不够，只要小于了4v左右，工作都不正常；

   ![notification.png]()

   + 出现上面两个问题：更换电池


3. 问题一：电池耗电量太高，如何解决这个问题？ 2019.4.26 
   + 买电池盒：用不能正常工作的电池测试板子？
   + 1）如果电池直接链接在5v上可以工作，那么需要改电源的启动方式；
   + 2）买可充电的电池，用于测试。
4. 问题二：不能正常关机，而且蓝牙不能开启，没有数据的采集？ 2019.4.28
   + 这是电压不够造成的影响。因为用的开关是触电开关，里面有一个电压比较电路，点压达不到的话，就不能正常工作。
   + 更换新的电池后就可以了。
5. 问题三：电池的供电时长
   + 刚才我测试反复开关启动每次间隔1分钟，50次～60次就因电压不够。用3.7V稳压可以正常启动
   + 那电池目前能工作1小时以内，因为还没有连上发数据，蓝牙发数据的时候会比较耗电。

## 血氧传感器

1. 问题一：Android 那边显示的，未能检测到耳夹，这个判断条件是什么？
   + 绘制波形的前提条件？
     + 设置绘制波形的数值 1000-1002；
     + 精度是两位数。
   
2. 问题二：血氧传感器灯能常亮，但是夹上耳夹后停止检测？ 2019.4.25

3. 问题三：传感器的制作工艺问题？
   
   + 灯的亮度和发光灯源的LED发光源的亮度有关
   + 可以通过代码控制LED的电流驱动电路
   
4. 问题四：对四种亮度不同的传感器进行检测，得到基本的定标

   + red=11310715, ir=11310715；
     + 这个是传感器光全反射后得到的数据
   + red = OX37 ;ir = ox37）设置电流的大小。7ma < I(am) < 12.5 ma
     + 新调的参数：如果使用这个，600个板子的代码固件得重新烧录

   | 光的亮度 | 用镜子全反射<br />（red = OX37 ;ir = ox37）                  | 正常耳朵测量数据                                             |
   | -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
   | 老芯1    | red=11310715, ir=10711405<br/>red=11310715, ir=10711455<br/>red=11310715, ir=10711470<br/>red=11310715, ir=10711586 | red=10997213, ir=10953989<br/>red=10997202, ir=10954032<br/>red=10997230, ir=10954048<br/>red=10997279, ir=10954189 |
   | 老芯2    | red=11310715, ir=10347021<br/>red=11310715, ir=10347027<br/>red=11310715, ir=10347020<br/>red=11310715, ir=10346993 | red=10935689, ir=10887544<br/>red=10935816, ir=10887725<br/>red=10935887, ir=10887922<br/>red=10935987, ir=10888265 |
   | 很弱1    | red=11310715, ir=11310715<br/>red=11310715, ir=11310715<br/>red=11310715, ir=11310715<br/>red=11310715, ir=11310715 | red=10769960, ir=11310715<br/>red=10770071, ir=11310715<br/>red=10770115, ir=11310715<br/>red=10770201, ir=11310715 |
   | 很弱2    | red=11310715, ir=10319545<br/>red=11310715, ir=10319603<br/>red=11310715, ir=10319677<br/>red=11310715, ir=10319592 | red=11274031, ir=10909276<br/>red=11274127, ir=10909560<br/>red=11274190, ir=10909787<br/>red=11274262, ir=10910030 |
   | 弱1      | red=11310715, ir=10657826<br/>red=11310715, ir=10657838<br/>red=11310715, ir=10658092<br/>red=11310715, ir=10658738 | red=11132163, ir=11003230<br/>red=11132096, ir=11003349<br/>red=11132151, ir=11003438<br/>red=11132318, ir=11003700 |
   | 弱2      | red=11310715, ir=11034390<br/>red=11310715, ir=11034530<br/>red=11310715, ir=11034476<br/>red=11310715, ir=11034452 | red=11310715, ir=11286652<br/>red=11310715, ir=11286673<br/>red=11310715, ir=11286836<br/>red=11310715, ir=11286767 |
   | 一般1    | red=11310715, ir=11310715<br/>red=11310715, ir=11310715<br/>red=11310715, ir=11310715<br/>red=11310715, ir=11310715 | red=11027173, ir=11034584<br/>red=11027146, ir=11034593<br/>red=11027095, ir=11034528<br/>red=11027098, ir=11034517 |
   | 一般2    | red=11310715, ir=11310715<br/>red=11310715, ir=11310715<br/>red=11310715, ir=11310715<br/>red=11310715, ir=11310715 | red=11202724, ir=11080446<br/>red=11202792, ir=11080804<br/>red=11202884, ir=11080930<br/>red=11202814, ir=11080985 |
   | 亮1      | red=11310715, ir=10835397<br/>red=11310715, ir=10835599<br/>red=11310715, ir=10835589<br/>red=11310715, ir=10835680 | red=11287808, ir=11276647<br/>red=11287763, ir=11276619<br/>red=11287716, ir=11276698<br/>red=11287664, ir=11276724 |
   | 亮2      | red=11310715, ir=11310715<br/>red=11310715, ir=11310715<br/>red=11310715, ir=11310715<br/>red=11310715, ir=11310715 | red=11310715, ir=11310715<br/>red=11310715, ir=11310715<br/>red=11310715, ir=11310715<br/>red=11310715, ir=11310715 |

   + 四种传感器的判断

     | 种类       | 光的亮度 | 采集                                                         |
     | ---------- | -------- | ------------------------------------------------------------ |
     | 老芯       |          | 波形正常；数据稳定；<br />镜子全反射后，红外光数据达不到限值 |
     | 新芯传感器 | 光很弱   | 两种传感器数据值反差很大<br />1号：数据异常，不能正常绘制波形<br />          正常测量式，红外光数据到限值<br />2号：数据偏高，很容易达到上限，但是能出波形 |
     |            | 光弱     | 两种传感器数据值反差很大<br />对耳朵夹的位置要求很高：偶尔才能出波形<br />2号：数据异常，不能正常绘制波形<br />          正常测量时，红外光数据到限值<br />1号：数据偏高，很容易达到上限，但是能出波形 |
     |            | 一般     | 波形正常；数据稳定；<br />红光数据很容易超过限制，但是波形能出来<br />1号：波形正常；数据稳定<br />2号：数据偏高，很容易达到上限，但是能出波形 |
     |            | 很亮     | 两种传感器数据值反差很大<br />1号：波形不太正常，有毛刺<br />2号：数据达到上限，不能出波形<br /> |

5. 问题五：在原来的电流情况下测试

   - red=11310715, ir=11310715；

     - 这个是传感器光全反射后得到的数据

   - red = OX24 ;ir = ox24）设置电流的大小。7ma = I

     

   | 光的亮度 | 用镜子全反射<br />（red = OX37 ;ir = ox37） | 正常耳朵测量数据                                             |
   | -------- | ------------------------------------------- | ------------------------------------------------------------ |
   | 老芯1    |                                             | red=10620044, ir=10594027<br/>red=10619752, ir=10593424<br/>red=10619601, ir=10593099<br/>red=10619573, ir=10592985 |
   | 老芯2    |                                             | red=10563671, ir=10591019<br/>red=10563645, ir=10590955<br/>red=10563620, ir=10590859<br/>red=10563637, ir=10590767 |
   | 很弱1    |                                             | red=10505003, ir=11053463<br/>red=10504848, ir=11053305<br/>red=10504890, ir=11053305<br/>red=10504936, ir=11053539 |
   | 很弱2    |                                             | red=10762628, ir=10512886<br/>red=10763067, ir=10512931<br/>red=10762799, ir=10512991<br/>red=10763076, ir=10513106 |
   | 弱1      |                                             | red=10710072, ir=10686591<br/>red=10710110, ir=10686599<br/>red=10710193, ir=10686847<br/>red=10710209, ir=10686926 |
   | 弱2      |                                             | red=10824749, ir=10804485<br/>red=10824732, ir=10804726<br/>red=10824740, ir=10804925<br/>red=10824809, ir=10804978 |
   | 一般1    |                                             | red=10708392, ir=10694301<br/>red=10708411, ir=10694307<br/>red=10708452, ir=10694444<br/>red=10708475, ir=10694555 |
   | 一般2    |                                             | red=10885274, ir=10879101<br/>red=10885320, ir=10879250<br/>red=10885298, ir=10879383<br/>red=10885305, ir=10879499 |
   | 亮1      |                                             | red=10811052, ir=10844797<br/>red=10811084, ir=10844854<br/>red=10811028, ir=10844820<br/>red=10811070, ir=10844814 |
   | 亮2      |                                             | red=10902997, ir=10899124<br/>red=10902829, ir=10899211<br/>red=10902930, ir=10899251<br/>red=10903098, ir=10899428 |

   - 四种传感器的判断

     | 种类       | 光的亮度 | 采集                                         |
     | ---------- | -------- | -------------------------------------------- |
     | 老芯       |          | 波形正常，但是存在毛边；<br />               |
     | 新芯传感器 | 光很弱   | 波形毛刺很多                                 |
     |            | 光弱     | 波形毛刺很多                                 |
     |            | 一般     | 波形顶部有毛刺                               |
     |            | 亮       | 1号：波形正常，<br />2号：波形毛刺较多<br /> |

     

## 主控MCU

1. 问题一：新板子和老板子？

   + 改变驱动电流后，采集的得到的数值将会产生变化
   + 针对情况3：新板子在测量的时候，电流挑动基本上是90-110ma
     + LED驱动电流过大，板子容易发烫
   + LED 寄存器驱动电流的值设置小于 0x3f = 12.6ma， 超过这个电流值，在测量耳朵的地方光值会全部反射回传感器，导致传感器的值超限。

   | 电流类型 / 板子类型                                      | 老板子（多次出现/跳变范围）    | 新板子                           |
   | -------------------------------------------------------- | ------------------------------ | -------------------------------- |
   | 只是开蓝牙，手机不连接；                                 | 110ma ( 110ma -180ma)          | 100ma (90ma-180ma)               |
   | 手机连接，传感器不连接(发送数据)                         | 110ma(110ma - 180ma)           | 110 / 170ma(110ma - 180ma)       |
   | 手机连接，传感器连接(LED驱动电流1ma)                     | 跳动频繁(110ma - 180ma)        | 90-110低值跳动频繁(90ma - 190ma) |
   | 手机连接，传感器连接(LED驱动电流小于12.6ma) 超过这个电流 |                                |                                  |
   | 手机连接，传感器连接(LED驱动电流7ma) -- 强哥设置的       |                                |                                  |
   | 手机连接，传感器连接(LED驱动电流25ma)                    |                                |                                  |
   | 手机连接，传感器连接(LED驱动电流50ma)                    | 170-190跳动频繁(110ma - 200ma) | 170-180跳动频繁(100ma - 200ma)   |

2. 问题二：次品传感器和一般传感器，数据采样
   
   + 打开串口工具就行

| 数据                                                         | 采样条件                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| red=11310715, ir=11310715<br/>red=11310715, ir=11310715<br/>red=11310715, ir=11310715<br/>red=11310715, ir=11310715 | red = OX37 ;ir = ox37 max30102 是一般亮度<br />上限值        |
| red=11098988, ir=11199567<br/>red=11098833, ir=11199314<br/>red=11098901, ir=11199516<br/>red=11098927, ir=11199612<br/>red=11098806, ir=11199634 | red = OX37 ;ir = ox37  max30102 是一般                       |
| red=10911363, ir=11043669<br/>red=10911381, ir=11043655<br/>red=10911316, ir=11043653<br/>red=10911358, ir=11043683<br/>red=10911316, ir=11043707<br/>red=10911333, ir=11043743 | red = OX37 ;ir = ox37  max30102 是一般<br />此时的波形相对稳定 |
| red=10644241, ir=10482866<br/>red=10644452 red=10698339, ir=10517499<br/>red=10698580, ir=10517642<br/>red=10698837, ir=10517772<br/>red=10699518, ir=10518510 | red = OX37 ;ir = ox37  max30102 是次品   +  波形             |
| red=10413331, ir=10280652<br/>red=10413263, ir=10280694<br/>red=10413169, ir=10280710<br/>red=10413119, ir=10280594<br/>red=10413043, ir=10280489 | red = OX24 ;ir = ox24  max30102 是次品                       |
|                                                              | 注意wakeup_init() 按键启动的那一块代码                       |
| red=10929400, ir=11233336<br/>red=10929421, ir=11233380<br/>red=10929415, ir=11233315<br/>red=10929362, ir=11233181<br/>red=10929296, ir=11233010<br/>red=10929242, ir=11232873<br/>red=10929151, ir=11232809 | 将传感器放在手臂上的检测<br />red = 0x3b;  ird = 0x3b <br />此时能达到反射的最大限值 |



## 二维码链接

1. 问题一：手机扫面二维码，连接时间太长？

   + 原因一：二维码的外面有一层塑料纸；
   + 原因一：APP扫描那块，连接时间的影响。

2. 问题二：空中健康监测APP波形在显示的时候，计算得到的数据一直不显示

   + 原因一：传感器采集到的数据达不到算法计算的需求
   + 原因二：算法的问题

   

## 算法

1. 手机上实时检测的波形和显示的数据
   + 算法是后台那边简化的算法；
   + 波形的绘制，数值的计算显示；
2. 算法计算的数值
   + 限值是：1000-1002；
   + Max传感器采集到的是一个8位数，算法的处理便是将收到的数据除以10000，取前四位数
   + 精度：保留两位小数，或者一位小数
     + 程：保留一位小数的时候，说明传感器采集到的数值比较好。
3. 数据报告的下载
   + 计算得到的数值是后台的算法；
   + 这个算法和手机上的算法是不同的。

